# 自动化 PR 审核系统

## 概述

本项目实现了一个全面的自动化 Pull Request 审核系统，旨在提高代码质量、减少人工审核负担，并确保所有 PR 符合项目的编码标准和最佳实践。

## 功能特性

### 1. 代码质量自动检查

自动化审核工作流会在每个 PR 上运行以下检查：

- **TypeScript 类型检查** - 确保代码类型安全，防止类型错误
- **ESLint 代码检查** - 验证代码风格和编码规范
- **构建验证** - 确保代码可以成功构建

### 2. PR 描述质量检查

自动验证 PR 描述的完整性：

- 检查是否包含详细的变更说明
- 验证是否完成了 PR 模板中的检查清单
- 提醒关联相关的 Issue

### 3. 变更文件智能分析

根据修改的文件类型提供上下文相关的警告：

- **配置文件变更** - 提醒说明安全影响和部署影响
- **数据库变更** - 确保包含迁移脚本并保持向后兼容
- **API 变更** - 提醒更新 API 文档
- **安全相关文件** - 对认证/授权变更进行额外审查
- **依赖变更** - 提醒与团队讨论新依赖
- **缺少测试更新** - 提醒添加或更新测试

## 工作流程

### 触发条件

自动审核工作流在以下情况下触发：

- PR 创建时
- PR 更新时（新提交推送）
- PR 重新打开时
- 草稿 PR 标记为"准备审核"时

**注意**：草稿 PR 不会触发自动审核，以允许开发者在未完成时进行工作。

### 审核流程

1. **代码质量检查作业**
   - 检出代码
   - 设置 Node.js 环境
   - 安装依赖
   - 运行类型检查
   - 运行代码检查
   - 运行构建
   - 发布包含所有结果的审核评论

2. **PR 描述检查作业**
   - 验证 PR 描述长度
   - 检查是否包含检查清单
   - 验证是否关联了相关 Issue
   - 如有问题，发布改进建议

3. **文件变更分析作业**
   - 获取变更文件列表
   - 分析文件类型和影响范围
   - 根据变更类型生成上下文警告
   - 提供变更摘要

## 审核检查清单

每个 PR 都会收到一个基于项目指南的综合审核检查清单：

### 代码质量
- [ ] 代码遵循项目编码标准和命名约定
- [ ] 没有潜在的空指针、类型错误或缺少异常处理
- [ ] 代码有良好的注释，特别是在复杂区域

### 测试
- [ ] 新功能包含适当的单元/集成测试
- [ ] 所有测试通过
- [ ] 测试覆盖率充足

### 安全性
- [ ] 没有 SQL 注入漏洞
- [ ] 没有 XSS 漏洞
- [ ] 没有未授权访问问题
- [ ] 敏感数据未暴露

### 架构与文档
- [ ] 模块划分清晰，遵循分层设计
- [ ] 未添加未经授权的第三方依赖
- [ ] API 变更已记录
- [ ] 破坏性变更有清晰说明和迁移路径

### 兼容性
- [ ] 前端兼容主流浏览器
- [ ] RESTful API 风格一致
- [ ] 接口/数据结构变更保持向后兼容

## 配置

### 工作流文件位置
`.github/workflows/pr-review.yml`

### 必需权限

```yaml
permissions:
  contents: read
  pull-requests: write
  issues: write
```

### 环境要求

- Node.js 20.x
- pnpm 8.x
- Ubuntu Latest

## 使用说明

### 对于贡献者

1. **创建 PR 时**
   - 使用 PR 模板填写完整的描述
   - 确保完成检查清单中的所有项目
   - 关联相关的 Issue（使用 `Closes #issue_number`）

2. **收到自动审核后**
   - 查看自动审核评论中的检查结果
   - 修复任何失败的检查（类型错误、代码检查问题等）
   - 处理变更文件分析中的警告
   - 完成审核检查清单中的所有项目

3. **持续改进**
   - 每次推送新提交时，自动审核会重新运行
   - 持续修复问题直到所有检查通过

### 对于审核者

1. **审核 PR 时**
   - 首先查看自动审核的结果
   - 重点关注自动检查未通过的项目
   - 验证作者是否完成了审核检查清单
   - 对于自动工具无法检测的问题进行人工审核

2. **上下文警告**
   - 注意变更文件分析中的警告
   - 对配置、数据库、安全相关的变更给予额外关注
   - 确保相应的文档和测试已更新

## 优势

1. **提高代码质量** - 自动捕获常见问题
2. **节省时间** - 减少人工审核基础检查的时间
3. **一致性** - 确保所有 PR 都经过相同的标准检查
4. **教育性** - 帮助贡献者了解项目标准
5. **安全性** - 及早发现潜在的安全问题
6. **文档化** - 强制要求良好的 PR 描述和文档更新

## 注意事项

- 自动审核是**辅助工具**，不能完全替代人工审核
- 某些复杂的架构或业务逻辑问题仍需人工判断
- 自动审核可能会产生误报，请根据实际情况判断
- 在合并 PR 前，建议至少有一位团队成员进行人工审核

## 故障排除

### 工作流未触发

- 确认 PR 不是草稿状态
- 检查仓库的 Actions 权限设置
- 确认工作流文件语法正确

### 检查失败

- 查看失败的具体步骤日志
- 在本地运行相同的命令（如 `pnpm run type-check`）
- 修复问题后重新推送

### 权限问题

- 确保仓库设置中启用了以下权限：
  - Settings → Actions → General → Workflow permissions: "Read and write permissions"

## 未来改进方向

- 集成更多安全扫描工具（如 Snyk、SonarQube）
- 添加性能测试基准检查
- 集成代码覆盖率报告
- 添加自动化的可访问性检查
- 集成国际化（i18n）验证

## 参考

- [GitHub Actions 文档](https://docs.github.com/en/actions)
- [项目编码规范](.github/copilot-instructions.md)
- [PR 审核指南](.github/instructions/*.instructions.md)

name: Check Links

on:
  pull_request:
    paths:
      - '**/*.md'
  schedule:
    - cron: '0 0 * * 0'  # Run weekly on Sundays
  workflow_dispatch:

jobs:
  check-links:
    name: Check Markdown Links
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
        
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          
      - name: Install markdown-link-check
        run: npm install -g markdown-link-check
        
      - name: Check links in markdown files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, check only modified files
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT origin/${{ github.base_ref }}...HEAD | grep '\.md$' || true)
            if [ -n "$CHANGED_FILES" ]; then
              echo "$CHANGED_FILES" | xargs -I {} markdown-link-check {} --config .github/markdown-link-check-config.json --quiet
            else
              echo "No markdown files changed"
            fi
          else
            # For scheduled runs or manual trigger, check all markdown files
            find . -name '*.md' -not -path "./node_modules/*" -not -path "./.next/*" | xargs -I {} markdown-link-check {} --config .github/markdown-link-check-config.json --quiet
          fi
